pipeline:
  name: test-release-pipeline
  identifier: testreleasepipeline
  projectIdentifier: DhrubaCI
  orgIdentifier: default
  tags: {}
  stages:
    - stage:
        variables:
          - name: SNYK_IMAGE
            type: String
            value: snyk/snyk-cli:1.745.0-maven-3.5.4
          - name: MAVEN_IMAGE
            type: String
            value: maven:3.8.3-openjdk-11-slim
        type: CI
        spec:
          execution:
            steps:
              - step:
                  type: BuildAndPushDockerRegistry
                  name: Build and Push an image to Docker Registry
                  identifier: Build_and_Push_an_image_to_Docker_Registry
                  spec:
                    connectorRef: account.harnessImage
                    repo: harnesscommunity/test-release
                    tags:
                      - latest
                    dockerfile: Dockerfile
              - step:
                  type: Security
                  name: security scan
                  identifier: security_scan
                  spec:
                    privileged: true
                    settings:
                      product_name: release-test
                      product_config_name: release-test
                      policy_type: orchestratedScan
                      scan_type: container
                      container_type: local_image
                      container_domain: hub.docker.com
                      container_project: test-release
                      container_tag: latest
                    imagePullPolicy: Always
              - step:
                  type: Run
                  name: Snyk Code Test
                  identifier: Snyk_Code_Test
                  spec:
                    connectorRef: account.harnessImage
                    image: <+CI.variables.SNYK_IMAGE>
                    shell: Sh
                    command: |-
                      snyk config set api=$SNYK_TOKEN
                      snyk code test || true
                    privileged: true
                    envVariables:
                      SNYK_TOKEN: <+secrets.getValue("org.SNYK_TOKEN")>
              - step:
                  type: Run
                  name: Build Container
                  identifier: Build_Container
                  spec:
                    connectorRef: account.harnessImage
                    image: docker:dind
                    shell: Sh
                    command: docker build -t harnesscommunity/test-release:<+pipeline.sequenceId> -f Dockerfile.harness .
                    imagePullPolicy: Always
          cloneCodebase: true
          serviceConfig:
            serviceRef: ""
            serviceDefinition:
              type: Kubernetes
              spec:
                variables: []
          serviceDependencies:
            - identifier: DiND
              name: DiND
              type: Service
              spec:
                connectorRef: account.harnessImage
                image: docker:dind
                privileged: true
                resources:
                  limits:
                    memory: 2.0Gi
                    cpu: "1.0"
          platform:
            os: Linux
            arch: Amd64
          runtime:
            type: Cloud
            spec: {}
        name: CI
        identifier: CI
  properties:
    ci:
      codebase:
        connectorRef: dhrubaaccountconnector
        repoName: release-test
        build: <+input>
